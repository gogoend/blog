<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>天气接口调用测试</title>
    <script src="https://cdn.staticfile.org/axios/0.19.2/axios.js"></script>
    <script src="https://cdn.staticfile.org/qs/6.8.0/qs.js"></script>
    <script src="https://cdn.staticfile.org/react/16.8.0/umd/react.development.js"></script>
    <script src="https://cdn.staticfile.org/react-dom/16.8.0/umd/react-dom.development.js"></script>
    <script src="https://cdn.staticfile.org/react-router-dom/5.1.2/react-router-dom.js"></script>
    <script src="https://cdn.staticfile.org/redux/4.0.5/redux.js"></script>
    <script src="https://cdn.staticfile.org/react-redux/7.2.0/react-redux.js"></script>
    <script src="https://cdn.staticfile.org/babel-standalone/6.26.0/babel.js"></script>
</head>

<body>
    <div id="app">
    </div>
    <script>
        axios.defaults.timeout = 15000
        axios.interceptors.request.use(
            config => {
                config.baseURL = './'
                // config.withCredentials = true // 允许携带token ,这个是解决跨域产生的相关问题
                config.timeout = 6000
                return config
            },
            error => {
                return Promise.reject(error)
            }
        )
        axios.interceptors.response.use(
            response => {
                return response
            },
            error => {
                return Promise.reject(error)
            }
        )
        function get(url, params) {
            return new Promise((resolve, reject) => {
                axios.get(url, {
                    params: params
                }).then(res => {
                    resolve(res.data);
                }).catch(err => {
                    reject(err.data)
                })
            });
        }
        function post(url, params) {
            return new Promise((resolve, reject) => {
                axios.post(url, Qs.stringify(params))
                    .then(res => {
                        resolve(res.data);
                    })
                    .catch(err => {
                        reject(err.data)
                    })
            });
        }

        let initState = {
            city: '110000',
            weatherInfo: {
                forecasts: []
            },
            cachedWeatherInfo: {}
        }
        function weatherApp(state = initState, action) {
            switch (action.type) {
                case 'CHANGE_CITY': {
                    return Object.assign({}, state, action.payload ? action.payload : {})
                }
                case 'CHANGE_CACHED_WEATHER_INFO': {
                    let tempState = Object.assign({}, state);
                    // tempState.cachedWeatherInfo
                    for (let key in action.payload.cachedWeatherInfo) {
                        tempState.cachedWeatherInfo[key] = action.payload.cachedWeatherInfo[key]
                    }
                    return tempState
                }
                default: {
                    // 这里暂不处理任何 action，
                    // 仅返回传入的 state。
                    return state
                }
            }

        }
        let store = Redux.createStore(
            weatherApp,
            window.__REDUX_DEVTOOLS_EXTENSION__ && window.__REDUX_DEVTOOLS_EXTENSION__()
        )
    </script>
    <script type="text/babel">
        async function getWeather(cityCode) {
            let data = await get('http://restapi.amap.com/v3/weather/weatherInfo', {
                key: '516786aa1da89347ad99cc19c24488ac',
                city: cityCode,
                extensions: 'all'
            })
            return data
        }

        const cityList = [
            {
                city: '北京',
                code: 110000
            },
            {
                city: '上海',
                code: 310000
            },
            {
                city: '成都',
                code: 510100
            },
            {
                city: '三沙',
                code: 460300
            },
            {
                city: '深圳',
                code: 440300
            },
            {
                city: '厦门',
                code: 350200
            },
            {
                city: '广州',
                code: 440100
            },
            {
                city: '重庆',
                code: 500000
            },
            {
                city: '杭州',
                code: 330100
            },
            {
                city: '拉萨',
                code: 540100
            }
        ]
        // App框架


        class App extends React.Component {
            constructor(props) {
                super(props)
            }
            render() {
                // let { Provider } = ReactRedux

                let {
                    // BrowserRouter: Router,
                    Route,
                    HashRouter: Router
                } = ReactRouterDOM
                return (
                    <Router>
                        <Route path="/" component={WeatherApp} />
                    </Router>
                )
            }
        }
        function mapStateToProps(state) {
            return Object.assign({}, state)
        }
        function mapDispatchToProps(state) {
            console.log(state)
            return {}
        }
        let AppWithStore = ReactRedux.connect(
            mapStateToProps,
            mapDispatchToProps
        )(App)

        function cacheInfo(city, info) {
            store.dispatch({
                type: 'CHANGE_CACHED_WEATHER_INFO',
                payload: {
                    cachedWeatherInfo: {
                        [city]: {
                            updateTime: new Date().getTime(),
                            info
                        }
                    }
                }
            })
        }
        // 天气App
        class WeatherApp extends React.Component {
            constructor(props) {
                super()
                this.state = {
                }
                this.cityChange = this.cityChange.bind(this)
            }
            async componentWillMount() {
                let { city } = store.getState()
                this.cityChange(city)
            }
            componentDidMount() {
                // this.unlisten = this.props.history.listen(location => {
                //     console.log(location)
                //     if (location.state) {
                //         let { city, weatherInfo } = location.state
                //         store.dispatch({
                //             type: 'CHANGE_CITY',
                //             payload: {
                //                 city,
                //                 weatherInfo
                //             }
                //         })
                //     }

                // });
            }
            componentWillUnmount() { }

            cityChange(e) {

                let { cachedWeatherInfo } = store.getState()
                let newCity = e.target ? e.target.value : e;

                // console.log(e instanceof Object ? e.target.value : e)

                let newInfo = {}

                // this.setState({
                //     city: newCity,
                //     weatherInfo: newInfo
                // })

                store.dispatch({
                    type: 'CHANGE_CITY',
                    payload: {
                        city: newCity,
                        weatherInfo: newInfo
                    }
                })

                // 之前出现下拉框内容改不掉的情况，似乎是因为没有以下这句
                this.forceUpdate()
                // console.log(newCity, store.getState().city)

                // this.props.history.push({
                //     pathname: `/home/${newCity}`,
                //     state: {
                //         city: newCity,
                //         weatherInfo: newInfo
                //     }
                // })
            }

            render() {
                let { city, weatherInfo } = store.getState()
                let {
                    // BrowserRouter: Router,
                    Switch,
                    Route,
                    Link,
                    useRouteMatch,
                    useParams,
                    HashRouter: Router,
                    IndexRoute
                } = ReactRouterDOM

                return (
                    <div>
                        <PublicNav cityChange={this.cityChange} city={city} />
                        <Switch>
                            <Route path="/home/:id" component={WeatherBox}></Route>
                            <Route path="/city-tip/:id" component={CityTip}></Route>
                        </Switch>
                        {/*
                        <Route path="/about" children={() => {
                            return <section>关于</section>
                        }} />
                        */}
                    </div>
                )
            }
            // componentWillReceiveProps(nextProps) { }
            // shouldComponentUpdate(nextProps, nextState) { }
            // componentWillUpdate(nextProps, nextState) { }
            // componentDidUpdate(prevProps, prevState) { }
        }

        // 公共nav
        class PublicNav extends React.Component {
            constructor(props) {
                super(props)
                this.state = {
                    // city:store.getState().city
                }
            }
            render() {
                let {
                    // BrowserRouter: Router,
                    Switch,
                    Route,
                    Link,
                    useRouteMatch,
                    useParams,
                    HashRouter: Router
                } = ReactRouterDOM
                let cityOptionDOM = cityList.map((item, index) => {
                    return (
                        <option key={index} value={item.code}>{item.city}</option>
                    )
                })
                return (
                    <nav className="app-nav">
                        <select onChange={this.props.cityChange} value={this.props.city}>
                            {cityOptionDOM}
                        </select>
                        <Link to={`/home/${this.props.city}`}>天气</Link>
                        <Link to={`/city-tip/${this.props.city}`}>城市</Link>
                    </nav>
                )
            }
        }

        // 天气展示区域
        class WeatherBox extends React.Component {
            constructor(props) {
                super(props)
                let _this = this
                _this.getCityWeather()
                // this.unsubscribe = store.subscribe(async () => {

                //     _this.setState({
                //         city: store.getState().city,
                //         weatherInfo: store.getState().weatherInfo
                //     })
                //     _this.render()
                // })

                this.state = {
                    city: '',
                    weatherInfo: {}
                }
            }
            componentDidMount() {

            }

            getCityWeather() {

                let { cachedWeatherInfo, city } = store.getState()

                let newInfo = {}
                if (cachedWeatherInfo[city] && ((new Date().getTime()) - cachedWeatherInfo[city].updateTime) < 5000) {
                    console.log('数据已缓存在本地')
                    newInfo = cachedWeatherInfo[city].info
                    store.dispatch({
                        type: 'CHANGE_CITY',
                        payload: {
                            city,
                            weatherInfo: newInfo
                        }
                    })
                    this.forceUpdate()
                    // debugger
                } else {
                    console.log('数据过期，正在重新加载')
                    newInfo = getWeather(city).then((res) => {
                        console.log(res)
                        // 缓存临时值
                        // debugger
                        cacheInfo(city, res)
                        store.dispatch({
                            type: 'CHANGE_CITY',
                            payload: {
                                city,
                                weatherInfo: res
                            }
                        })
                        this.forceUpdate()
                    })
                }


                // this.setState({
                //     city,
                //     weatherInfo: newInfo
                // })
            }
            render() {

                // this.getCityWeather()
                if (!Array.isArray(this.state.weatherInfo.forecasts)) {
                    var casts = []
                } else {
                    var { casts } = (this.state.weatherInfo.forecasts.length === 0 ? { casts: [] } : this.state.weatherInfo.forecasts[0])
                }

                if (casts.length > 0) {
                    debugger
                }

                let chineseDigi = [
                    '〇', '一', '二', '三', '四', '五', '六', '七', '八', '九', '十'
                ]
                let forecastDOM = ''
                if (Array.isArray(casts)) {
                    forecastDOM = casts.map((item, index) => {
                        return (
                            <li key={index}>
                                <span>{item.date} 星期{item.week === '7' ? '日' : chineseDigi[item.week]}</span>
                                <section>
                                    <header>
                                        白天
                                    </header>
                                    <ul>
                                        <li>{item.dayweather}</li>
                                        <li>{item.daytemp}℃</li>
                                        <li>{item.daywind}</li>
                                        <li>{item.daypower}级</li>
                                    </ul>
                                </section>
                                <section>
                                    <header>
                                        夜间
                                    </header>
                                    <ul>
                                        <li>{item.nightweather}</li>
                                        <li>{item.nighttemp}℃</li>
                                        <li>{item.nightwind}</li>
                                        <li>{item.nightpower}级</li>
                                    </ul>
                                </section>
                            </li>
                        )
                    })
                }
                return <section className="weather-app-container">
                    <h1>天气:{this.state.city}</h1>
                    <ul>
                        {forecastDOM}
                    </ul>
                </section>
            }
        }

        // 城市信息
        class CityTip extends React.Component {
            constructor(props) {
                super(props)
            }
            render() {
                return <section>
                    <h1>当前城市：{this.props.city}</h1>
                </section>
            }
        }
        let { Provider } = ReactRedux

        ReactDOM.render(<Provider store={store}><AppWithStore /></Provider>, document.getElementById('app'))
    </script>
</body>

</html>