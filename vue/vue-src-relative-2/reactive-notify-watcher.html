<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
        function isObj(val){
            return val && typeof val === 'object'
        }
        class Dep{
            notify(){}
        }
        class Observer{
            val;
            dep;
            update(){}
            constructor(val){
                this.val = val
                this.dep = new Dep()
                val.__ob__ = this
                Object.defineProperty(val,'__ob__',{
                    value: this,
                    enumerable: false
                })
                this.walk(val)
            }
            walk(obj){
                Object.keys(obj).forEach(key => {
                    defineObserve(obj, key)
                })
            }
        }
        // 为引用类型对象添加__ob__，值为Observer实例
        function observe(val) {
            if(!isObj(val)){
                return
            }
            let ob
            if(val.__ob__ && val.__ob__ instanceof Observer){
                ob = val.__ob__
            } else if (Object.isExtensible(val)){
                ob = new Observer(val)
            }
            return ob
        }
        function defineObserve(obj, key) {
            let val = obj[key]
            let dep = new Dep()
            Object.defineProperty(obj, key, {
                enumerable: true,
                configurable: true,
                get() {
                    return val
                },
                set(nVal) {
                    val = nVal
                    dep.notify()
                    observe(nVal)
                    // if (isObj(nVal)) {
                    //     Object.keys(nVal).forEach(key2 => {
                    //         defineObserve(nVal, key2)
                    //     })
                    // }
                }
            })
            observe(val)
            // if (isObj(val)) {
            //     Object.keys(val).forEach(key2 => {
            //         defineObserve(val, key2)
            //     })
            // }
        }
    </script>
    <script>
        const app = {
            a: 1,
            b: 2,
            c: {
                d: 3,
                e: {
                    f: 4,
                    g: 5,
                    h: {
                        i: 6,
                        j: 7
                    }
                },
                k: {
                    l: 8,
                    m: {
                        n: 9,
                        o: {
                            p: 10
                        }
                    },
                    q: 11,
                },
                r: 12,
                s: 13
            }
        }
        function init() {
            observe(app)
            // Object.keys(app).forEach(key => {
            //     defineObserve(app, key)
            // })
        }
        init()
    </script>
</body>

</html>